<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Statistical Modeling with Time-to-event Mediators and Competing Risks ‚Ä¢ CMAverse</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png">
<link rel="icon" type="‚Äùimage/svg+xml‚Äù" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Statistical Modeling with Time-to-event Mediators and Competing Risks">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CMAverse</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>

  </a>
</li>
<li>
  <a href="../articles/overview.html">Overview of Modeling Approaches</a>
</li>
<li>
  <a href="../articles/quickstart.html">Quickstart</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Examples

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/single_mediator.html">Statistical Modeling with a Single Mediator</a>
    </li>
    <li>
      <a href="../articles/case_control.html">Statistical Modeling for a Case Control Study</a>
    </li>
    <li>
      <a href="../articles/multiple_imputation.html">Statistical Modeling with Missing Data</a>
    </li>
    <li>
      <a href="../articles/post_exposure_confounding.html">Statistical Modeling with Post-exposure Confounding</a>
    </li>
    <li>
      <a href="../articles/measurement_error.html">Sensitivity Analysis for Measurement Error</a>
    </li>
    <li>
      <a href="../articles/time_to_event_mediator.html">Statistical Modeling with Time-to-event Mediators and Competing Risks</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>

    Functions
  </a>
</li>
<li>
  <a href="https://github.com/XiaoniXu/CMAverse/" class="external-link">
    <span class="fa fa-github fa-lg"></span>

    GitHub
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Statistical Modeling with Time-to-event
Mediators and Competing Risks</h1>
            
            <h4 data-toc-skip class="date">2025-12-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/XiaoniXu/CMAverse/blob/HEAD/vignettes/time_to_event_mediator.Rmd" class="external-link"><code>vignettes/time_to_event_mediator.Rmd</code></a></small>
      <div class="hidden name"><code>time_to_event_mediator.Rmd</code></div>

    </div>

    
    
<p>We follow the framework of Arce Domingo-Relloso <em>et al.</em>
(2024), who extend the mediational g-formula to accommodate longitudinal
mediators and competing events in a single causal framework. In studies
where both the mediator and competing risks evolve over time,
traditional mediation estimators may fail to correctly identify
path-specific effects. The approach implemented in
<code>cmest_med_longi</code> overcomes this challenge by modeling the
structure‚Äîexposure, mediator history, competing event history, and
survival process‚Äîand then evaluating the interventions through the
g-formula.</p>
<p>This example illustrates how to use <code>cmest_med_longi</code> to
estimate path-specific causal effects in settings where:</p>
<ul>
<li>the mediator is time-varying,</li>
<li>the outcome is a time-to-event variable, and</li>
<li>competing risks may occur prior to the event of interest.</li>
</ul>
<p>The method follows the framework of Arce Domingo-Relloso et
al.¬†(2024), which extends the mediational g-formula to accommodate
longitudinal mediators and competing events simultaneously. When both
the mediator and the competing event process evolve over time, standard
mediation estimators may not correctly separate direct and indirect
pathways. The approach implemented in <code>cmest_med_longi</code>
overcomes this limitation by modeling the full joint longitudinal
structure‚Äîexposure, mediator history, competing event history, and
survival process‚Äîand applying the g-formula to evaluate counterfactual
interventions.</p>
<div class="section level2">
<h2 id="path-specific-effects">Path-specific effects<a class="anchor" aria-label="anchor" href="#path-specific-effects"></a>
</h2>
<p>Under this framework, the total effect of an exposure on a
time-to-event outcome is decomposed into four interpretable
components.</p>
<ol style="list-style-type: decimal">
<li><p>Direct effect (DE)<br>
The portion of the exposure effect not operating through either the
mediator trajectory or the competing event process. This effect is
defined by modifying the exposure while holding both mediator and
competing event histories at levels that would occur under a reference
exposure value.</p></li>
<li><p>Indirect effect through the mediator (IEM)<br>
The part of the effect transmitted through the entire history of the
time-varying mediator, while fixing the competing event process to its
reference distribution. This represents how changes in the mediator
pathway contribute to the exposure‚Äìoutcome association.</p></li>
<li><p>Indirect effect through the competing event (IED)<br>
The portion of the effect transmitted through the competing-risk
process. Because a competing event can alter the risk set for the
primary outcome, this pathway measures how differences in the occurrence
or timing of the competing event contribute to the exposure
effect.</p></li>
<li><p>Total effect (TE)<br>
The overall effect of the exposure on the outcome when the mediator
pathway, the competing event pathway, and any direct mechanisms are all
allowed to vary naturally.</p></li>
</ol>
<p>Under the identification assumptions presented in Arce
Domingo-Relloso et al.¬†(2024), each path-specific effect can be
expressed using the longitudinal mediational g-formula. The
<code>cmest_med_longi</code> function implements these estimands by
specifying regression models for the exposure, mediator, competing event
process, and time-to-event outcome; generating counterfactual
trajectories under fixed exposure values; and computing the
corresponding g-formula risk contrasts.</p>
<p>In the remainder of this example, we construct a simplified dataset
with a mediator measured at three time points, a competing event
indicator also measured at three time points, and a time-to-event
outcome. We then demonstrate how to estimate the four path-specific
effects using <code>cmest_med_longi</code>.</p>
</div>
<div class="section level2">
<h2 id="estimands">Estimands<a class="anchor" aria-label="anchor" href="#estimands"></a>
</h2>
<p>We consider a baseline exposure
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>,
a vector of baseline covariates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>L</mi><mn>0</mn></msub><annotation encoding="application/x-tex">L_0</annotation></semantics></math>,
a longitudinal mediator
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>M</mi><mo accent="true">‚Äæ</mo></mover><mi>K</mi></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>M</mi><mn>1</mn></msub><mo>,</mo><mi>‚Ä¶</mi><mo>,</mo><msub><mi>M</mi><mi>K</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\bar M_K = (M_1,\dots,M_K)</annotation></semantics></math>,
a competing event process
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>D</mi><mo accent="true">‚Äæ</mo></mover><mi>K</mi></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>D</mi><mn>1</mn></msub><mo>,</mo><mi>‚Ä¶</mi><mo>,</mo><msub><mi>D</mi><mi>K</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\bar D_K = (D_1,\dots,D_K)</annotation></semantics></math>
and a time-to-event outcome
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>
observed over discrete follow-up intervals
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>‚Ä¶</mi><mo>,</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">k=1,\dots,K</annotation></semantics></math>.
Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>S</mi><mo accent="true">‚Äæ</mo></mover><mi>K</mi></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>S</mi><mn>1</mn></msub><mo>,</mo><mi>‚Ä¶</mi><mo>,</mo><msub><mi>S</mi><mi>K</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\bar S_K = (S_1,\dots,S_K)</annotation></semantics></math>
denote the survival indicator up to each interval, where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>k</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">S_k = 1</annotation></semantics></math>
if the individual is alive and event-free at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>.</p>
<p>We define counterfactual outcomes under possibly contrary-to-fact
interventions on the exposure, the mediator history, and the survival
process, following the path-specific framework of Domingo-Relloso et
al.¬†(2024). For two exposure levels
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>
(reference) and <span class="math inline">$a^\*$</span> (higher level),
the quantities of interest at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k+1</annotation></semantics></math>
are effects on the risk difference scale:</p>
<ul>
<li><p>Direct effect (DE): effect of changing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>
to <span class="math inline">$a^\*$</span> while holding both the
mediator and the survival process at the levels they would take under
exposure
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>:
<span class="math display">$$
DE_{k+1}(a^\*, a)
= \mathbb{E}\big\{Y_{k+1}(a^\*, \bar M_k(a,\bar S_{k-1}(a)), \bar
S_k(a,\bar M_k(a)))\big\}
- \mathbb{E}\big\{Y_{k+1}(a, \bar M_k(a,\bar S_{k-1}(a)), \bar
S_k(a,\bar M_k(a)))\big\}.
$$</span></p></li>
<li><p>Indirect effect through the longitudinal mediator (IEM): effect
that operates by changing the entire mediator trajectory from what it
would be under
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mi>a</mi></mrow><annotation encoding="application/x-tex">A=a</annotation></semantics></math>
to what it would be under <span class="math inline">$A=a^\*$</span>,
while forcing the survival process to evolve as under
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mi>a</mi></mrow><annotation encoding="application/x-tex">A=a</annotation></semantics></math>:
<span class="math display">$$
IEM_{k+1}(a^\*, a)
= \mathbb{E}\big\{Y_{k+1}(a^\*, \bar M_k(a^\*,\bar S_{k-1}(a)), \bar
S_k(a,\bar M_k(a^\*)))\big\}
- \mathbb{E}\big\{Y_{k+1}(a^\*, \bar M_k(a,\bar S_{k-1}(a)), \bar
S_k(a,\bar M_k(a)))\big\}.
$$</span></p></li>
<li><p>Indirect effect through the competing event (IED): effect that
operates by changing the survival and competing risk process from what
it would be under
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mi>a</mi></mrow><annotation encoding="application/x-tex">A=a</annotation></semantics></math>
to what it would be under <span class="math inline">$A=a^\*$</span>,
while keeping the mediator trajectory at the level it would take under
<span class="math inline">$A=a^\*$</span>: <span class="math display">$$
IED_{k+1}(a^\*, a)
= \mathbb{E}\big\{Y_{k+1}(a^\*, \bar M_k(a^\*,\bar S_{k-1}(a^\*)), \bar
S_k(a^\*,\bar M_k(a^\*)))\big\}
- \mathbb{E}\big\{Y_{k+1}(a^\*, \bar M_k(a^\*,\bar S_{k-1}(a)), \bar
S_k(a,\bar M_k(a^\*)))\big\}.
$$</span></p></li>
<li><p>Total effect (TE): overall effect of changing the exposure from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>
to <span class="math inline">$a^\*$</span>, allowing both the mediator
and the competing risk process to evolve under their natural levels for
each exposure: <span class="math display">$$
TE_{k+1}(a^\*, a)
= \mathbb{E}\big\{Y_{k+1}(a^\*, \bar M_k(a^\*,\bar S_{k-1}(a^\*)), \bar
S_k(a^\*,\bar M_k(a^\*)))\big\}
- \mathbb{E}\big\{Y_{k+1}(a, \bar M_k(a,\bar S_{k-1}(a)), \bar
S_k(a,\bar M_k(a)))\big\}.
$$</span></p></li>
</ul>
<p>By construction, the three path-specific effects sum to the total
effect: <span class="math display">$$
TE_{k+1}(a^\*, a) = DE_{k+1}(a^\*, a) + IEM_{k+1}(a^\*, a) +
IED_{k+1}(a^\*, a).
$$</span></p>
<p>In practice, the function <code>cmest_med_longi()</code> reports
these effects at a user-specified time horizon <span class="math inline">$t^\*$</span> (for example, 10 years of follow-up),
expressed as differences in cumulative risk (or in cumulative incidence
derived from the additive hazards model). It also returns the proportion
of the total effect explained by the paths through the mediator and
competing risk, <span class="math display">$$
Q(t^\*) = \frac{IEM(t^\*) + IED(t^\*)}{TE(t^\*)} \times 100,
$$</span> interpreted as the percentage of the total effect operating
through the mediator trajectory (including the nested pathway through
the competing event).</p>
</div>
<div class="section level2">
<h2 id="estimation">Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h2>
<p>Under standard identifiability conditions for longitudinal mediation
with competing risks (exchangeability, positivity, consistency and no
interference), the counterfactual risks above are identified by the
mediational g-formula. For generic arguments
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>M</mi></msub><mo>,</mo><msub><mi>a</mi><mi>S</mi></msub><mo>,</mo><msub><mi>a</mi><mi>Y</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a_M, a_S, a_Y)</annotation></semantics></math>
indicating the exposure level carried through the mediator, survival and
outcome components, the g-formula identifies
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>œï</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>M</mi></msub><mo>,</mo><msub><mi>a</mi><mi>S</mi></msub><mo>,</mo><msub><mi>a</mi><mi>Y</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>ùîº</mi><mo stretchy="false" form="prefix">{</mo><msub><mi>Y</mi><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>Y</mi></msub><mo>,</mo><msub><mover><mi>M</mi><mo accent="true">‚Äæ</mo></mover><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>M</mi></msub><mo>,</mo><msub><mover><mi>S</mi><mo accent="true">‚Äæ</mo></mover><mrow><mi>k</mi><mo>‚àí</mo><mn>1</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>S</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msub><mover><mi>S</mi><mo accent="true">‚Äæ</mo></mover><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>S</mi></msub><mo>,</mo><msub><mover><mi>M</mi><mo accent="true">‚Äæ</mo></mover><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>M</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">
\phi(a_M, a_S, a_Y)
= \mathbb{E}\{Y_{k+1}(a_Y, \bar M_k(a_M,\bar S_{k-1}(a_S)), \bar S_k(a_S,\bar M_k(a_M)))\}
</annotation></semantics></math> as a functional of the observed data
distribution. The path-specific effects can then be written as contrasts
of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>œï</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>,
for example <span class="math display">$$
DE_{k+1}(a^\*, a) = \phi(a,a,a^\*) - \phi(a,a,a), \quad
IEM_{k+1}(a^\*, a) = \phi(a^\*,a,a^\*) - \phi(a,a,a^\*),
$$</span> <span class="math display">$$
IED_{k+1}(a^\*, a) = \phi(a^\*,a^\*,a^\*) - \phi(a^\*,a,a^\*), \quad
TE_{k+1}(a^\*, a) = \phi(a^\*,a^\*,a^\*) - \phi(a,a,a).
$$</span></p>
<p>The function <code>cmest_med_longi()</code> implements a parametric
mediational g-formula algorithm tailored to time-varying mediators and
competing risks:</p>
<ol style="list-style-type: decimal">
<li><p>Choose two exposure levels
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>
and <span class="math inline">$a^\*$</span> (for example, the 25th and
75th percentiles of the exposure distribution) and a time horizon <span class="math inline">$t^\*$</span>.</p></li>
<li><p>Fit sequential regression models for the longitudinal mediator
and the competing event at each visit
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>‚Ä¶</mi><mo>,</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">k = 1,\dots,K</annotation></semantics></math>,
typically using linear or logistic models of the form
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mi>k</mi></msub><mo>‚à£</mo><msub><mi>‚Ñã</mi><mrow><mi>k</mi><mo>‚àí</mo><mn>1</mn></mrow></msub><mo>‚àº</mo><msub><mi>f</mi><mi>M</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>M</mi><mi>k</mi></msub><mo>‚à£</mo><msub><mi>M</mi><mrow><mi>k</mi><mo>‚àí</mo><mn>1</mn></mrow></msub><mo>,</mo><mi>A</mi><mo>,</mo><msub><mi>L</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mspace width="1.0em"></mspace><msub><mi>D</mi><mi>k</mi></msub><mo>‚à£</mo><msub><mi>‚Ñã</mi><mi>k</mi></msub><mo>‚àº</mo><msub><mi>f</mi><mi>D</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>D</mi><mi>k</mi></msub><mo>‚à£</mo><msub><mi>M</mi><mi>k</mi></msub><mo>,</mo><mi>A</mi><mo>,</mo><msub><mi>L</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">
M_k \mid \mathcal{H}_{k-1} \sim f_M(M_k \mid M_{k-1}, A, L_0), \quad
D_k \mid \mathcal{H}_k \sim f_D(D_k \mid M_k, A, L_0),
</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>‚Ñã</mi><mrow><mi>k</mi><mo>‚àí</mo><mn>1</mn></mrow></msub><annotation encoding="application/x-tex">\mathcal{H}_{k-1}</annotation></semantics></math>
denotes the observed history up to visit
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>‚àí</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k-1</annotation></semantics></math>.</p></li>
<li><p>Transform the data into counting-process format and fit an
additive hazards model for the time-to-event outcome including the full
mediator history, exposure and baseline covariates, for example using
the <code>timereg</code> package:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œª</mi><mi>Y</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>‚à£</mo><mi>A</mi><mo>,</mo><mover><mi>M</mi><mo accent="true">‚Äæ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msub><mi>L</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>Œ≤</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>Œ≤</mi><mi>A</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>A</mi><mo>+</mo><msub><mi>Œ≤</mi><mi>M</mi></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>‚ä§</mi></msup><mover><mi>M</mi><mo accent="true">‚Äæ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>Œ≤</mi><mi>L</mi></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>‚ä§</mi></msup><msub><mi>L</mi><mn>0</mn></msub><mi>.</mi></mrow><annotation encoding="application/x-tex">
\lambda_Y(t \mid A, \bar M(t), L_0)
= \beta_0(t) + \beta_A(t) A + \beta_M(t)^\top \bar M(t) + \beta_L(t)^\top L_0.
</annotation></semantics></math></p></li>
<li>
<p>Using the fitted models, simulate counterfactual trajectories of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>M</mi><mo accent="true">‚Äæ</mo></mover><mi>K</mi></msub><annotation encoding="application/x-tex">\bar M_K</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>D</mi><mo accent="true">‚Äæ</mo></mover><mi>K</mi></msub><annotation encoding="application/x-tex">\bar D_K</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>S</mi><mo accent="true">‚Äæ</mo></mover><mi>K</mi></msub><annotation encoding="application/x-tex">\bar S_K</annotation></semantics></math>
under each of the required intervention regimes:</p>
<ul>
<li>mediator and survival under exposure
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>,</li>
<li>mediator under <span class="math inline">$a^\*$</span> with survival
under
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>,</li>
<li>mediator and survival under <span class="math inline">$a^\*$</span>,
and, if needed, hybrid histories that mix these components. For each
regime, predict the counterfactual outcome process
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y(t)</annotation></semantics></math>
up to <span class="math inline">$t^\*$</span>, either on the rate
difference scale (via the additive hazards coefficients) or on the
survival probability scale (via the model-based survival function).</li>
</ul>
</li>
<li><p>Average the simulated outcomes over individuals to obtain
empirical estimates of the counterfactual risks at <span class="math inline">$t^\*$</span> for each regime. Plug these estimates
into the contrasts above to obtain <span class="math inline">$\widehat{DE}(t^\*)$</span>, <span class="math inline">$\widehat{IEM}(t^\*)$</span>, <span class="math inline">$\widehat{IED}(t^\*)$</span> and <span class="math inline">$\widehat{TE}(t^\*)$</span>, and compute <span class="math display">$$
\widehat{Q}(t^\*) = \frac{\widehat{IEM}(t^\*) +
\widehat{IED}(t^\*)}{\widehat{TE}(t^\*)} \times 100.
$$</span></p></li>
<li><p>Optionally, repeat the entire procedure over bootstrap resamples
to obtain confidence intervals for each effect and for the mediated
proportion <span class="math inline">$Q(t^\*)$</span>.</p></li>
</ol>
<p>This algorithm mirrors the multistate mediator framework implemented
in <code>cmest_multistate</code>, but extends it to the path-specific
decomposition with a longitudinal mediator nested within the competing
risk process, as described in Domingo-Relloso et al.¬†(2024).</p>
</div>
<div class="section level2">
<h2 id="dag-representation">DAG representation<a class="anchor" aria-label="anchor" href="#dag-representation"></a>
</h2>
<hr>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'dplyr'</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     filter, lag</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:base':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     intersect, setdiff, setequal, union</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: package 'ggplot2' was built under R version 4.5.2</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://xiaonixu.github.io/CMAverse/">CMAverse</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cmdag.html">cmdag</a></span><span class="op">(</span></span>
<span>  outcome  <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>  exposure <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>  mediator <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"M1"</span>, <span class="st">"M2"</span>, <span class="st">"M3"</span><span class="op">)</span>,     <span class="co"># mediator measured at 3 time points</span></span>
<span>  basec    <span class="op">=</span> <span class="st">"L0"</span>,                    <span class="co"># baseline confounder</span></span>
<span>  postc    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"D1"</span>, <span class="st">"D2"</span>, <span class="st">"D3"</span><span class="op">)</span>,     <span class="co"># competing risk indicator at 3 time points</span></span>
<span>  node     <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  text_col <span class="op">=</span> <span class="st">"white"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_to_event_mediator_files/figure-html/unnamed-chunk-2-1.png" class="r-plt" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-causal/ggdag" class="external-link">ggdag</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: package 'ggdag' was built under R version 4.5.2</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'ggdag'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     filter</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.dagitty.net" class="external-link">dagitty</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: package 'dagitty' was built under R version 4.5.2</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 1. Manually specify coordinates (ggdag manual style)</span></span>
<span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">name</span>, <span class="op">~</span><span class="va">x</span>, <span class="op">~</span><span class="va">y</span>,</span>
<span>  <span class="st">"L0"</span>,  <span class="fl">0</span>,   <span class="fl">0</span>,</span>
<span>  <span class="st">"A"</span>,   <span class="fl">1</span>,   <span class="fl">0</span>,</span>
<span>  <span class="st">"M1"</span>,  <span class="fl">2</span>,   <span class="fl">0</span>,</span>
<span>  <span class="st">"M2"</span>,  <span class="fl">3</span>,   <span class="fl">0</span>,</span>
<span>  <span class="st">"M3"</span>,  <span class="fl">4</span>,   <span class="fl">0</span>,</span>
<span>  <span class="st">"Y"</span>,   <span class="fl">5</span>,   <span class="fl">0</span>,</span>
<span>  <span class="st">"D1"</span>,  <span class="fl">2</span>,  <span class="op">-</span><span class="fl">1</span>,</span>
<span>  <span class="st">"D2"</span>,  <span class="fl">3</span>,  <span class="op">-</span><span class="fl">1</span>,</span>
<span>  <span class="st">"D3"</span>,  <span class="fl">4</span>,  <span class="op">-</span><span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 2. Define the DAG structure</span></span>
<span><span class="va">dag_longi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-causal.github.io/ggdag/reference/dagify.html" class="external-link">dagify</a></span><span class="op">(</span></span>
<span>  <span class="co"># outcome</span></span>
<span>  <span class="va">Y</span>  <span class="op">~</span> <span class="va">A</span> <span class="op">+</span> <span class="va">L0</span> <span class="op">+</span> <span class="va">M1</span> <span class="op">+</span> <span class="va">M2</span> <span class="op">+</span> <span class="va">M3</span> <span class="op">+</span> <span class="va">D1</span> <span class="op">+</span> <span class="va">D2</span> <span class="op">+</span> <span class="va">D3</span>,</span>
<span></span>
<span>  <span class="co"># mediator process</span></span>
<span>  <span class="va">M1</span> <span class="op">~</span> <span class="va">A</span> <span class="op">+</span> <span class="va">L0</span>,</span>
<span>  <span class="va">M2</span> <span class="op">~</span> <span class="va">A</span> <span class="op">+</span> <span class="va">L0</span> <span class="op">+</span> <span class="va">M1</span>,</span>
<span>  <span class="va">M3</span> <span class="op">~</span> <span class="va">A</span> <span class="op">+</span> <span class="va">L0</span> <span class="op">+</span> <span class="va">M2</span>,</span>
<span></span>
<span>  <span class="co"># competing risk process</span></span>
<span>  <span class="va">D1</span> <span class="op">~</span> <span class="va">A</span> <span class="op">+</span> <span class="va">L0</span>,</span>
<span>  <span class="va">D2</span> <span class="op">~</span> <span class="va">A</span> <span class="op">+</span> <span class="va">L0</span> <span class="op">+</span> <span class="va">D1</span> <span class="op">+</span> <span class="va">M1</span>,</span>
<span>  <span class="va">D3</span> <span class="op">~</span> <span class="va">A</span> <span class="op">+</span> <span class="va">L0</span> <span class="op">+</span> <span class="va">D2</span> <span class="op">+</span> <span class="va">M2</span>,</span>
<span></span>
<span>  <span class="co"># exposure model</span></span>
<span>  <span class="va">A</span>  <span class="op">~</span> <span class="va">L0</span>,</span>
<span></span>
<span>  exposure <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>  outcome  <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>  coords   <span class="op">=</span> <span class="va">coords</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co">## 4. Plot following the ggdag manual style</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dag_longi</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-causal.github.io/ggdag/reference/geom_dag_edges.html" class="external-link">geom_dag_edges</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-causal.github.io/ggdag/reference/node_point.html" class="external-link">geom_dag_node</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-causal.github.io/ggdag/reference/geom_dag_text.html" class="external-link">geom_dag_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">name</span><span class="op">)</span>, vjust <span class="op">=</span> <span class="op">-</span><span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-causal.github.io/ggdag/reference/theme_dag_blank.html" class="external-link">theme_dag</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_to_event_mediator_files/figure-html/unnamed-chunk-3-1.png" class="r-plt" width="700"></p>
</div>
<div class="section level2">
<h2 id="med_longitudinal-function">
<code>med_longitudinal</code> function<a class="anchor" aria-label="anchor" href="#med_longitudinal-function"></a>
</h2>
<p>Here we demonstrate the original med_longitudinal function:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Main function to conduct mediation analysis in presence of time-varying mediators, a survival outcome and competing risks in difference in hazards scale</span></span>
<span></span>
<span><span class="va">med_longitudinal</span><span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">L</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">M</span>, <span class="va">m</span>, <span class="va">Y</span>, <span class="va">treat</span><span class="op">=</span><span class="st">'logcocr'</span>, <span class="va">control.value</span><span class="op">=</span><span class="va">a</span>, <span class="va">treat.value</span><span class="op">=</span><span class="va">a_star</span>, <span class="va">data</span>, <span class="va">time_points</span>, <span class="va">peryr</span><span class="op">=</span><span class="fl">100000</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">N</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">NL</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">L</span><span class="op">)</span></span>
<span>  <span class="va">NM</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">boot</span> <span class="op">&lt;-</span> <span class="fu">foreach</span><span class="op">(</span>i<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">10000</span>, .combine<span class="op">=</span><span class="st">'rbind'</span><span class="op">)</span> <span class="op">%dopar%</span> <span class="op">{</span></span>
<span>    <span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span>, replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>   </span>
<span>    <span class="va">MModel</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">NM</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">MModel</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">rmvnorm</span><span class="op">(</span><span class="fl">1</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">M</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">M</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">YModel</span> <span class="op">=</span> <span class="fu">rmvnorm</span><span class="op">(</span><span class="fl">1</span>, mean <span class="op">=</span> <span class="va">Y</span><span class="op">$</span><span class="va">gamma</span>, sigma <span class="op">=</span> <span class="va">Y</span><span class="op">$</span><span class="va">robvar.gamma</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">PredictL_a</span> <span class="op">&lt;-</span> <span class="va">PredictL_astar</span> <span class="op">&lt;-</span> <span class="va">PredictL_astar_a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,nrow<span class="op">=</span><span class="va">N</span>,ncol<span class="op">=</span><span class="va">NL</span><span class="op">)</span></span>
<span>    <span class="va">PredictM_a</span> <span class="op">&lt;-</span> <span class="va">PredictM_astar</span> <span class="op">&lt;-</span> <span class="va">PredictM_a_astar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,nrow<span class="op">=</span><span class="va">N</span>,ncol<span class="op">=</span><span class="va">NM</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Predict M1</span></span>
<span>    <span class="va">pred.data.astar.m1</span> <span class="op">&lt;-</span> <span class="va">pred.data.a.m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame</a></span><span class="op">(</span><span class="va">M</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="va">ind</span>,<span class="op">]</span></span>
<span>    <span class="va">pred.data.astar.m1</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">treat.value</span></span>
<span>    <span class="va">pred.data.a.m1</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">control.value</span></span>
<span>    </span>
<span>    <span class="va">m1mat.astar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">M</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">pred.data.astar.m1</span><span class="op">)</span></span>
<span>    <span class="va">m1mat.a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">M</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">pred.data.a.m1</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">PredictM_astar</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">MModel</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">m1mat.astar</span><span class="op">)</span></span>
<span>    <span class="va">PredictM_a</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">MModel</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">m1mat.a</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Predict L1</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">NL</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">pred.data.astar.l1</span> <span class="op">&lt;-</span> <span class="va">pred.data.a.l1</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.a.l1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame</a></span><span class="op">(</span><span class="va">L</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="va">ind</span>,<span class="op">]</span></span>
<span>      <span class="va">pred.data.astar.l1</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.a.l1</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">treat.value</span></span>
<span>      <span class="va">pred.data.a.l1</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">control.value</span></span>
<span>      <span class="va">pred.data.astar.l1</span><span class="op">[</span>, <span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">PredictM_astar</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>      <span class="va">pred.data.a.l1</span><span class="op">[</span>, <span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.a.l1</span><span class="op">[</span>, <span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">PredictM_a</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>      </span>
<span>      <span class="va">PredictL_astar_a</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">N</span>, size<span class="op">=</span><span class="fl">1</span>, prob<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">L</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">pred.data.astar.a.l1</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">PredictL_a</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">N</span>, size<span class="op">=</span><span class="fl">1</span>, prob<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">L</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">pred.data.a.l1</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">PredictL_astar</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">N</span>, size<span class="op">=</span><span class="fl">1</span>, prob<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">L</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">pred.data.astar.l1</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Predict Li (only if more than one time point)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">NM</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">NM</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">pred.data.a.m</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.m</span> <span class="op">&lt;-</span> <span class="va">pred.data.a.astar.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow<span class="op">=</span><span class="va">N</span>, ncol<span class="op">=</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame</a></span><span class="op">(</span><span class="va">M</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pred.data.a.m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pred.data.astar.m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pred.data.a.astar.m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">M</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,<span class="st">"term.labels"</span><span class="op">)</span></span>
<span>        <span class="va">names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pred.data.a.m</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pred.data.a.m</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">M</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,<span class="st">"term.labels"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>        </span>
<span>        <span class="va">pred.data.a.m</span><span class="op">[</span>, <span class="va">names</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred.data.a.astar.m</span><span class="op">[</span>, <span class="va">names</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.m</span><span class="op">[</span>, <span class="va">names</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame</a></span><span class="op">(</span><span class="va">M</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="va">ind</span>,<span class="va">names</span><span class="op">]</span></span>
<span>        <span class="va">pred.data.a.m</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred.data.a.astar.m</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">control.value</span></span>
<span>        <span class="va">pred.data.astar.m</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">treat.value</span></span>
<span>        </span>
<span>        <span class="va">pred.data.a.m</span><span class="op">[</span>, <span class="va">m</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">PredictM_a</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="va">pred.data.astar.m</span><span class="op">[</span>, <span class="va">m</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">PredictM_astar</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="va">pred.data.a.astar.m</span><span class="op">[</span>, <span class="va">m</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">PredictM_a_astar</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="va">i</span><span class="op">==</span><span class="fl">2</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="va">pred.data.a.astar.m</span><span class="op">[</span>, <span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">PredictM_a</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="op">}</span></span>
<span>        </span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="va">NL</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="va">m1mat.a.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">.</span>,data<span class="op">=</span><span class="va">pred.data.a.m</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_a</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span>          <span class="va">m1mat.astar.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">pred.data.astar.m</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_astar</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span>          <span class="va">m1mat.a.astar.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">pred.data.a.astar.m</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_astar_a</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span>          </span>
<span>          <span class="va">PredictM_a</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_a</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">MModel</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">m1mat.a.m</span><span class="op">)</span></span>
<span>          <span class="va">PredictM_astar</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_astar</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">MModel</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">m1mat.astar.m</span><span class="op">)</span></span>
<span>          <span class="va">PredictM_a_astar</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_astar_a</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">MModel</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">m1mat.a.astar.m</span><span class="op">)</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span><span class="op">{</span></span>
<span>          <span class="va">m1mat.a.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">.</span>,data<span class="op">=</span><span class="va">pred.data.a.m</span><span class="op">)</span></span>
<span>          <span class="va">m1mat.astar.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">pred.data.astar.m</span><span class="op">)</span></span>
<span>          <span class="va">m1mat.a.astar.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">.</span>, data <span class="op">=</span> <span class="va">pred.data.a.astar.m</span><span class="op">)</span></span>
<span>          </span>
<span>          <span class="va">PredictM_a</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">MModel</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">m1mat.a.m</span><span class="op">)</span></span>
<span>          <span class="va">PredictM_astar</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">MModel</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">m1mat.astar.m</span><span class="op">)</span></span>
<span>          <span class="va">PredictM_a_astar</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">MModel</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">m1mat.a.astar.m</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>        </span>
<span>        <span class="kw">if</span><span class="op">(</span><span class="va">NL</span> <span class="op">&gt;</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">i</span><span class="op">&lt;=</span><span class="va">NL</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="va">pred.data.a.l</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.l</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.a.l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow<span class="op">=</span><span class="va">N</span>, ncol<span class="op">=</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame</a></span><span class="op">(</span><span class="va">L</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pred.data.a.l</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pred.data.astar.l</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pred.data.astar.a.l</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">L</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,<span class="st">"term.labels"</span><span class="op">)</span></span>
<span>          <span class="va">names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pred.data.a.l</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pred.data.a.l</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">L</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,<span class="st">"term.labels"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>          </span>
<span>          <span class="va">pred.data.a.l</span><span class="op">[</span>, <span class="va">names</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.a.l</span><span class="op">[</span>, <span class="va">names</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.l</span><span class="op">[</span>, <span class="va">names</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html" class="external-link">model.frame</a></span><span class="op">(</span><span class="va">L</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="va">ind</span>,<span class="va">names</span><span class="op">]</span></span>
<span>          <span class="va">pred.data.a.l</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">control.value</span></span>
<span>          <span class="va">pred.data.astar.l</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.a.l</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">treat.value</span></span>
<span>          </span>
<span>          <span class="va">pred.data.a.l</span><span class="op">[</span>, <span class="va">m</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">PredictM_a</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span></span>
<span>          <span class="va">pred.data.astar.l</span><span class="op">[</span>, <span class="va">m</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">PredictM_astar</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span></span>
<span>          <span class="va">pred.data.astar.a.l</span><span class="op">[</span>, <span class="va">m</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">PredictM_a_astar</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span></span>
<span>          </span>
<span>          <span class="va">PredictL_a</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_a</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_a</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">1</span>, prob<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">L</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">pred.data.a.l</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_a</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>,<span class="op">]</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="va">PredictL_astar</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_astar</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_astar</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">1</span>, prob<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">L</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">pred.data.astar.l</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_astar</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>,<span class="op">]</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="va">PredictL_astar_a</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_astar_a</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_astar_a</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">1</span>, prob<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">L</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">pred.data.astar.a.l</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">PredictL_astar_a</span><span class="op">[</span>,<span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>,<span class="op">]</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    </span>
<span>    <span class="co"># Predict Y</span></span>
<span>    <span class="co"># Data augmentation method for person-time database</span></span>
<span>    <span class="co"># PredictY_DEIEM: a*, D1_a, M1_aD1a, D2_aD1aM1aD1a, M2_aD1aM1aD2a</span></span>
<span>    <span class="co"># PredictY_TEDE_2: a, D1_a, M1_aD1a, D2_aD1a M1aD1a, M2_aD1aM1aD2a</span></span>
<span>    <span class="co"># PredictY_IEMIED: a*, D1_a, M1_a*D1a, D2_aD1a M1a*D1a, M2_a*D1aM1a*D2a</span></span>
<span>    <span class="co"># PredictY_IEDTE_1: a*, D1_a*, M1_a*D1a*, D2_a*D1a*M1a*D1a*, M2_a*D1a*M1a*D2a*</span></span>
<span>    </span>
<span>    <span class="va">pred.data.a.y</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.y</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.a.y</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.a.astar.a.y</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">ind</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'idno'</span>,<span class="fu">getvarnames</span><span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">call</span><span class="op">)</span><span class="op">$</span><span class="va">xvar</span><span class="op">[</span><span class="op">-</span><span class="fl">2</span><span class="op">]</span>,<span class="va">m</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">'time.since.first.exam'</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">pred.data.a.y</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">control.value</span></span>
<span>    <span class="va">pred.data.astar.y</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.a.y</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.a.astar.a.y</span><span class="op">[</span>, <span class="va">treat</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">treat.value</span></span>
<span>    <span class="va">pred.data.a.y</span><span class="op">[</span>, <span class="va">m</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred.data.astar.a.y</span><span class="op">[</span>, <span class="va">m</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">PredictM_a</span></span>
<span>    <span class="va">pred.data.astar.y</span><span class="op">[</span>, <span class="va">m</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">PredictM_astar</span></span>
<span>    <span class="va">pred.data.astar.a.astar.a.y</span><span class="op">[</span>, <span class="va">m</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">PredictM_a_astar</span></span>
<span>    <span class="va">pred.data.astar.a.astar.a.y</span><span class="op">[</span>, <span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">PredictM_a</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>    </span>
<span></span>
<span>    <span class="co">########################</span></span>
<span>    </span>
<span>    <span class="co"># Data augmentation method for the counterfactuals</span></span>
<span>    <span class="va">vector_time_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">time_points</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">vector_time_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vector_time_points</span>, <span class="va">m</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">time_points</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># pred.data.a.y</span></span>
<span>    <span class="va">pred.data.a.y</span><span class="op">$</span><span class="va">id_boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">pred.data.a.y</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">df_tv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html" class="external-link">reshape</a></span><span class="op">(</span><span class="va">pred.data.a.y</span>, direction <span class="op">=</span> <span class="st">"long"</span>, varying <span class="op">=</span> <span class="va">vector_time_points</span>,</span>
<span>                     sep <span class="op">=</span> <span class="st">"_"</span>, times<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">time_points</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, idvar<span class="op">=</span><span class="st">'id_boot'</span><span class="op">)</span></span>
<span>    <span class="va">df_tv</span> <span class="op">&lt;-</span> <span class="va">df_tv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">df_tv</span><span class="op">$</span><span class="va">id_boot</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">df_pred.data.a.y</span> <span class="op">&lt;-</span> <span class="va">df_tv</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu">getvarnames</span><span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">call</span><span class="op">)</span><span class="op">$</span><span class="va">xvar</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">df_tv</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">df_pred.data.a.y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">.</span>,data<span class="op">=</span><span class="va">df_pred.data.a.y</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># pred.data.astar.y</span></span>
<span>    <span class="va">pred.data.astar.y</span><span class="op">$</span><span class="va">id_boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">pred.data.astar.y</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">df_tv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html" class="external-link">reshape</a></span><span class="op">(</span><span class="va">pred.data.astar.y</span>, direction <span class="op">=</span> <span class="st">"long"</span>, varying <span class="op">=</span> <span class="va">vector_time_points</span>,</span>
<span>                     sep <span class="op">=</span> <span class="st">"_"</span>, times<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">time_points</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, idvar<span class="op">=</span><span class="st">'id_boot'</span><span class="op">)</span></span>
<span>    <span class="va">df_tv</span> <span class="op">&lt;-</span> <span class="va">df_tv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">df_tv</span><span class="op">$</span><span class="va">idno</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">df_pred.data.astar.y</span> <span class="op">&lt;-</span> <span class="va">df_tv</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu">getvarnames</span><span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">call</span><span class="op">)</span><span class="op">$</span><span class="va">xvar</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">df_tv</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">df_pred.data.astar.y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">.</span>,data<span class="op">=</span><span class="va">df_pred.data.astar.y</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># pred.data.astar.a.astar.a.y</span></span>
<span>    <span class="va">pred.data.astar.a.astar.a.y</span><span class="op">$</span><span class="va">id_boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">pred.data.astar.a.astar.a.y</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">df_tv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html" class="external-link">reshape</a></span><span class="op">(</span><span class="va">pred.data.astar.a.astar.a.y</span>, direction <span class="op">=</span> <span class="st">"long"</span>, varying <span class="op">=</span> <span class="va">vector_time_points</span>,</span>
<span>                     sep <span class="op">=</span> <span class="st">"_"</span>, times<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">time_points</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, idvar<span class="op">=</span><span class="st">'id_boot'</span><span class="op">)</span></span>
<span>    <span class="va">df_tv</span> <span class="op">&lt;-</span> <span class="va">df_tv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">df_tv</span><span class="op">$</span><span class="va">idno</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">df_pred.data.astar.a.astar.a.y</span> <span class="op">&lt;-</span> <span class="va">df_tv</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu">getvarnames</span><span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">call</span><span class="op">)</span><span class="op">$</span><span class="va">xvar</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">df_tv</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">df_pred.data.astar.a.astar.a.y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">.</span>,data<span class="op">=</span><span class="va">df_pred.data.astar.a.astar.a.y</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># pred.data.astar.a.y</span></span>
<span>    <span class="va">pred.data.astar.a.y</span><span class="op">$</span><span class="va">id_boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">pred.data.astar.a.y</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">df_tv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html" class="external-link">reshape</a></span><span class="op">(</span><span class="va">pred.data.astar.a.y</span>, direction <span class="op">=</span> <span class="st">"long"</span>, varying <span class="op">=</span> <span class="va">vector_time_points</span>,</span>
<span>                     sep <span class="op">=</span> <span class="st">"_"</span>, times<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">time_points</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, idvar<span class="op">=</span><span class="st">'id_boot'</span><span class="op">)</span></span>
<span>    <span class="va">df_tv</span> <span class="op">&lt;-</span> <span class="va">df_tv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">df_tv</span><span class="op">$</span><span class="va">idno</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">df_pred.data.astar.a.y</span> <span class="op">&lt;-</span> <span class="va">df_tv</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu">getvarnames</span><span class="op">(</span><span class="va">Y</span><span class="op">$</span><span class="va">call</span><span class="op">)</span><span class="op">$</span><span class="va">xvar</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">df_tv</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">df_pred.data.astar.a.y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">.</span>,data<span class="op">=</span><span class="va">df_pred.data.astar.a.y</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co">#######################</span></span>
<span></span>
<span>    <span class="va">PredictY_DEIEM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">YModel</span>, <span class="va">df_pred.data.astar.a.y</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">PredictY_TEDE_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">YModel</span>, <span class="va">df_pred.data.a.y</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">PredictY_IEMIED</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">YModel</span>, <span class="va">df_pred.data.astar.a.astar.a.y</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">PredictY_IEDTE_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">tcrossprod</a></span><span class="op">(</span><span class="va">YModel</span>, <span class="va">df_pred.data.astar.y</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">DE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">PredictY_DEIEM</span> <span class="op">-</span> <span class="va">PredictY_TEDE_2</span><span class="op">)</span><span class="op">*</span><span class="fl">100000</span></span>
<span>    <span class="va">IEM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">PredictY_IEDTE_1</span> <span class="op">-</span> <span class="va">PredictY_IEMIED</span><span class="op">)</span><span class="op">*</span><span class="fl">100000</span></span>
<span>    <span class="va">IED</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">PredictY_IEMIED</span> <span class="op">-</span> <span class="va">PredictY_DEIEM</span><span class="op">)</span><span class="op">*</span><span class="fl">100000</span></span>
<span>    <span class="va">TE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">PredictY_IEDTE_1</span> <span class="op">-</span> <span class="va">PredictY_TEDE_2</span><span class="op">)</span><span class="op">*</span><span class="fl">100000</span></span>
<span>    <span class="va">effects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">DE</span>, <span class="va">IEM</span>, <span class="va">IED</span>, <span class="va">TE</span><span class="op">)</span></span>
<span>    <span class="va">effects</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Calculate the effects</span></span>
<span>  <span class="co"># Direct effect</span></span>
<span>  <span class="va">DE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">boot</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="va">DE_low</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">boot</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span>  <span class="va">DE_up</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">boot</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span>  <span class="va">DE_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">DE</span>,<span class="fl">2</span><span class="op">)</span>, <span class="st">' ('</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">DE_low</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">', '</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">DE_up</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">')'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Indirect effect through M</span></span>
<span>  <span class="va">IEM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">boot</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="va">IEM_low</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">boot</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span>  <span class="va">IEM_up</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">boot</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span>  <span class="va">IEM_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">IEM</span>,<span class="fl">2</span><span class="op">)</span>, <span class="st">' ('</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">IEM_low</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">', '</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">IEM_up</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">')'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Indirect effect through D</span></span>
<span>  <span class="va">IED</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">boot</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="va">IED_low</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">boot</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span>  <span class="va">IED_up</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">boot</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span>  <span class="va">IED_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">IED</span>,<span class="fl">2</span><span class="op">)</span>, <span class="st">' ('</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">IED_low</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">', '</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">IED_up</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">')'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Total effect</span></span>
<span>  <span class="va">TE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">boot</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="va">TE_low</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">boot</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span>  <span class="va">TE_up</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">boot</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span>  <span class="va">TE_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">TE</span>,<span class="fl">2</span><span class="op">)</span>, <span class="st">' ('</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">TE_low</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">', '</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">TE_up</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">')'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Relative indirect effect</span></span>
<span>  <span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">IEM</span><span class="op">/</span><span class="va">TE</span><span class="op">*</span><span class="fl">100</span>,<span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>DE<span class="op">=</span><span class="va">DE_result</span>, IEM<span class="op">=</span><span class="va">IEM_result</span>, IED<span class="op">=</span><span class="va">IED_result</span>, TE<span class="op">=</span><span class="va">TE_result</span>, Q<span class="op">=</span><span class="va">Q</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulated-data-example">Simulated data example<a class="anchor" aria-label="anchor" href="#simulated-data-example"></a>
</h2>
<p>We simulate the data using a simulated dataset created by Yuchen
Zhang:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"simData.Y10D10.Population.RData"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>  </span>
<span><span class="co"># subset the data into 10000 instead of 2000. 2025/8/26</span></span>
<span><span class="va">simData</span> <span class="op">&lt;-</span> <span class="va">simData</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">simData</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">10000</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">simData</span><span class="op">[</span>, <span class="va">M_1</span> <span class="op">:=</span> <span class="va">M1</span><span class="op">]</span></span>
<span><span class="va">simData</span><span class="op">[</span>, <span class="va">M_2</span> <span class="op">:=</span> <span class="va">M2</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Counting-process helpers the outcome model needs</span></span>
<span><span class="va">simData</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span>tstart <span class="op">=</span> <span class="fl">0</span>, tstop <span class="op">=</span> <span class="va">time_to_event</span>,</span>
<span>               time.since.first.exam_1 <span class="op">=</span> <span class="fl">0</span>,</span>
<span>               time.since.first.exam_2 <span class="op">=</span> <span class="va">time_to_event</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Unique ID for tmerge / reshape</span></span>
<span><span class="va">simData</span><span class="op">[</span>, <span class="va">id_unique</span> <span class="op">:=</span> <span class="va">.I</span><span class="op">]</span></span>
<span></span>
<span><span class="va">simData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">simData</span><span class="op">)</span></span>
<span></span>
<span><span class="va">boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">1000</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ind</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">simData</span><span class="op">)</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">simData</span><span class="op">[</span><span class="va">ind</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># ---- IDs expected by med_longitudinal ----</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">id_unique</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">idno</span>      <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="st">"id"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="va">data</span><span class="op">$</span><span class="va">id</span> <span class="kw">else</span> <span class="va">data</span><span class="op">$</span><span class="va">id_unique</span>   <span class="co">### CHANGED</span></span>
<span></span>
<span>  <span class="co"># ---- Make sure the columns that Y/med_longitudinal will look for exist ----</span></span>
<span>  <span class="co"># Y uses const(M) by label -&gt; create a baseline M column (mapped to M_1 here)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="st">"M"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="va">data</span><span class="op">$</span><span class="va">M</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">M_1</span>                            <span class="co">### CHANGED</span></span>
<span></span>
<span>  <span class="co"># ---- mediator &amp; dropout models (fit on the resample) ----</span></span>
<span>  <span class="va">M1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">M_1</span> <span class="op">~</span> <span class="va">E</span> <span class="op">+</span> <span class="va">C</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span>  <span class="va">L1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">D1</span> <span class="op">~</span> <span class="va">E</span> <span class="op">+</span> <span class="va">M_1</span> <span class="op">+</span> <span class="va">C</span>, data <span class="op">=</span> <span class="va">data</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">M2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">M_2</span> <span class="op">~</span> <span class="va">E</span> <span class="op">+</span> <span class="va">M_1</span> <span class="op">+</span> <span class="va">C</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span>  <span class="va">L2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">D2</span> <span class="op">~</span> <span class="va">E</span> <span class="op">+</span> <span class="va">M_2</span> <span class="op">+</span> <span class="va">C</span>, data <span class="op">=</span> <span class="va">data</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ---- counting-process data for the outcome model ----</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/tmerge.html" class="external-link">tmerge</a></span><span class="op">(</span></span>
<span>    data1 <span class="op">=</span> <span class="va">data</span>,</span>
<span>    data2 <span class="op">=</span> <span class="va">data</span>,</span>
<span>    id    <span class="op">=</span> <span class="va">id_unique</span>,</span>
<span>    endpt <span class="op">=</span> <span class="fu">event</span><span class="op">(</span><span class="va">time_to_event</span>, <span class="va">eventHappened</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># reshape time-varying mediator into long to inject via tdc()</span></span>
<span>  <span class="va">df_tv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html" class="external-link">reshape</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    direction <span class="op">=</span> <span class="st">"long"</span>,</span>
<span>    varying   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      M    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"M_1"</span>, <span class="st">"M_2"</span><span class="op">)</span>,</span>
<span>      time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"time.since.first.exam_1"</span>, <span class="st">"time.since.first.exam_2"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    v.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"M"</span>, <span class="st">"time.since.first.exam"</span><span class="op">)</span>,</span>
<span>    times   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    idvar   <span class="op">=</span> <span class="st">"id_unique"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">df_tv</span> <span class="op">&lt;-</span> <span class="va">df_tv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">df_tv</span><span class="op">$</span><span class="va">id_unique</span>, <span class="va">df_tv</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/tmerge.html" class="external-link">tmerge</a></span><span class="op">(</span></span>
<span>    data1 <span class="op">=</span> <span class="va">df</span>,</span>
<span>    data2 <span class="op">=</span> <span class="va">df_tv</span>,</span>
<span>    id    <span class="op">=</span> <span class="va">id_unique</span>,</span>
<span>    M     <span class="op">=</span> <span class="fu">tdc</span><span class="op">(</span><span class="va">time.since.first.exam</span>, <span class="va">M</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ---- outcome model ----</span></span>
<span>  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu">timereg</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/timereg/man/aalen.html" class="external-link">aalen</a></span><span class="op">(</span></span>
<span>    <span class="fu">Surv</span><span class="op">(</span><span class="va">tstart</span>, <span class="va">tstop</span>, <span class="va">endpt</span><span class="op">)</span> <span class="op">~</span> <span class="fu">const</span><span class="op">(</span><span class="va">E</span><span class="op">)</span> <span class="op">+</span> <span class="fu">const</span><span class="op">(</span><span class="va">M</span><span class="op">)</span> <span class="op">+</span> <span class="fu">const</span><span class="op">(</span><span class="va">C</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">df</span>,</span>
<span>    resample.iid <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    n.sim <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ---- assemble arguments for med_longitudinal ----</span></span>
<span>  <span class="va">treat</span> <span class="op">&lt;-</span> <span class="st">"E"</span></span>
<span>  <span class="va">L</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>L1 <span class="op">=</span> <span class="va">L1</span>, L2 <span class="op">=</span> <span class="va">L2</span><span class="op">)</span></span>
<span>  <span class="va">Mlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>M1 <span class="op">=</span> <span class="va">M1</span>, M2 <span class="op">=</span> <span class="va">M2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># IMPORTANT: time_points should be the bare time labels the function pastes onto</span></span>
<span>  <span class="co">#            "time.since.first.exam_" internally (i.e., "1","2", not the full col names)</span></span>
<span>  <span class="va">mvec</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"M_1"</span>, <span class="st">"M_2"</span><span class="op">)</span></span>
<span>  <span class="va">tpts</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"2"</span><span class="op">)</span>                                                     <span class="co">### CHANGED</span></span>
<span></span>
<span>  <span class="va">a</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">E</span>, <span class="fl">0.25</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">a_star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">E</span>, <span class="fl">0.75</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ---- call the function; pass the *wide* baseline data ----</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">med_longitudinal</span><span class="op">(</span></span>
<span>    L <span class="op">=</span> <span class="va">L</span>, M <span class="op">=</span> <span class="va">Mlist</span>, m <span class="op">=</span> <span class="va">mvec</span>, Y <span class="op">=</span> <span class="va">Y</span>, treat <span class="op">=</span> <span class="va">treat</span>,</span>
<span>    control.value <span class="op">=</span> <span class="va">a</span>, treat.value <span class="op">=</span> <span class="va">a_star</span>,</span>
<span>    data <span class="op">=</span> <span class="va">data</span>,                     <span class="co">### keep 'data' (not 'df'); the function subsets from here</span></span>
<span>    time_points <span class="op">=</span> <span class="va">tpts</span>,              <span class="co">### now "1","2" -&gt; matches columns via paste0 inside</span></span>
<span>    peryr <span class="op">=</span> <span class="fl">100000</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">boot</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We visualize the results</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">boot</span><span class="op">)</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">boot</span><span class="op">)</span> <span class="op">==</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">boot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DE"</span>,<span class="st">"IEM"</span>,<span class="st">"IED"</span>,<span class="st">"TE"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">boot</span><span class="op">)</span><span class="op">)</span>     </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">boot</span><span class="op">)</span><span class="op">)</span>  </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">boot</span>, <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">qfun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">qs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.025</span>,<span class="fl">.5</span>,<span class="fl">.975</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>LCL <span class="op">=</span> <span class="va">qs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, Median <span class="op">=</span> <span class="va">qs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, UCL <span class="op">=</span> <span class="va">qs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, SD <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">x</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">summ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">boot</span>, <span class="fl">2</span>, <span class="va">qfun</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">summ</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>Result 2025/10/09:</p>
<p>$DE [1] ‚Äú116.04 (50.61, 184.85)‚Äù</p>
<p>$IEM [1] ‚Äú31.52 (-26.96, 88.81)‚Äù</p>
<p>$IED [1] ‚Äú-0.36 (-0.67, 0)‚Äù</p>
<p>$TE [1] ‚Äú147.6 (100.05, 194.07)‚Äù</p>
<p>$Q 50% 21.35</p>
<p>The exposure had a large direct effect on the outcome (DE = 116.0),
with more modest and uncertain mediation through the longitudinal
mediator (IEM = 31.5) and a negligible competing-risk pathway (IED =
‚àí0.36). The total effect (TE = 147.6) reflects that most of the
exposure‚Äôs influence operates directly rather than through mediated
biological or competing-risk pathways.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Baoyi Shi, Ziqing Wang, Christine Choirat, <a href="https://www.lindavaleri.com/" class="external-link">Linda Valeri</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
